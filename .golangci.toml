# golangci-lint v2 configuration
# https://golangci-lint.run/docs/configuration/
version = "2"

# Run options
[run]
timeout = "5m"
tests = true
modules-download-mode = "readonly"

# Linter defaults
[linters]
# Start with defaults, explicitly enable extras
default = "standard"
enable = [
  # Code quality
  "errcheck", # Check for unchecked errors
  "govet", # Go vet checks
  "staticcheck", # Staticcheck suite
  "unused", # Find unused code
  "ineffassign", # Detect ineffectual assignments

  # Style & consistency
  "misspell", # Find misspellings
  "unconvert", # Remove unnecessary conversions

  # Bug prevention
  "bodyclose", # HTTP response body must be closed
  "noctx", # HTTP requests should use context
  "rowserrcheck", # Check sql.Rows.Err()
  "sqlclosecheck", # Check sql.Rows/Stmt are closed

  # Modern Go
  "copyloopvar", # Detect unnecessary loop var copies (Go 1.22+)
  "intrange", # Suggest range over int (Go 1.22+)

  # Security
  "gosec", # Security checks

  # Performance
  "prealloc", # Suggest slice preallocation
]
disable = [
  # Too noisy for this project
  "wrapcheck", # We don't wrap all errors
  "exhaustruct", # Don't require all struct fields
  "varnamelen", # Short var names are fine
  "nlreturn", # Blank line before return not required
  "wsl", # Whitespace linter too strict
]

# Linter-specific settings
[linters-settings]

[linters-settings.errcheck]
check-type-assertions = true
check-blank = false # Allow _ = err for intentional ignores

[linters-settings.govet]
enable-all = true
disable = ["fieldalignment"] # Not worth the churn

[linters-settings.staticcheck]
checks = ["all", "-SA1019"] # Allow deprecated for now (we have our own)

[linters-settings.misspell]
locale = "US"

[linters-settings.gosec]
excludes = [
  "G104", # Audit errors not checked (we handle intentionally)
  "G304", # File path from variable (required for our use case)
]

[linters-settings.prealloc]
simple = true
for-loops = true

# Issue formatting
[issues]
exclude-use-default = true
max-issues-per-linter = 50
max-same-issues = 3

# Exclude test files from strict linting
[[issues.exclude-rules]]
path = "test"
linters = ["errcheck", "gosec", "prealloc", "intrange"]

# Exclude examples from deprecation warnings
[[issues.exclude-rules]]
path = "examples"
linters = ["staticcheck"]

# Exclude e2e tests from strict checks
[[issues.exclude-rules]]
path = "e2e"
linters = ["gosec", "errcheck", "prealloc", "staticcheck"]

# G304: File path from variable is required for our use case
[[issues.exclude-rules]]
linters = ["gosec"]
text = "G304"

# G306: 0644 permissions are intentional for MODULE.bazel files
[[issues.exclude-rules]]
linters = ["gosec"]
text = "G306"

# G301: 0755 permissions are standard for directories
[[issues.exclude-rules]]
linters = ["gosec"]
text = "G301"

# G204: Subprocess with variable is required for e2e tests
[[issues.exclude-rules]]
linters = ["gosec"]
text = "G204"

# Output format
[output]
sort-results = true
sort-order = ["linter", "file"]
show-stats = true
